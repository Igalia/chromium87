From 0c1cf44ea4f36cd3f866427e31cd5d58a0071d12 Mon Sep 17 00:00:00 2001
From: Ivan Murashov <ivan.murashov@lge.com>
Date: Sat, 24 Oct 2020 11:45:03 +0300
Subject: [PATCH] GCC: suppress invalid-offsetof warnings

:Release Notes:
Suppressed invalid-offsetof warnings

:Detailed Notes:
quic_inlined_frame.h and quic_frame.h have validation
code. GCC warns the code, but it seems definitely
unneeded.
This results in a large amount of warnings for GCC,
because responsible header is included very often.
So suppress the warning.

:Testing Performed:
Build O20 starfish

:QA Notes:

:Issues Addressed:
[NEVA-5230] Fix or suppress numerous compile warnings
---
 quic/core/frames/quic_frame.h         | 9 +++++++++
 quic/core/frames/quic_inlined_frame.h | 9 +++++++++
 2 files changed, 18 insertions(+)

diff --git a/quic/core/frames/quic_frame.h b/quic/core/frames/quic_frame.h
index 6e096e3d..48990774 100644
--- a/quic/core/frames/quic_frame.h
+++ b/quic/core/frames/quic_frame.h
@@ -124,6 +124,11 @@ struct QUIC_EXPORT_PRIVATE QuicFrame {
   };
 };
 
+#if defined(__GNUC__)
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Winvalid-offsetof"
+#endif
+
 static_assert(std::is_standard_layout<QuicFrame>::value,
               "QuicFrame must have a standard layout");
 static_assert(sizeof(QuicFrame) <= 24,
@@ -131,6 +136,10 @@ static_assert(sizeof(QuicFrame) <= 24,
 static_assert(offsetof(QuicStreamFrame, type) == offsetof(QuicFrame, type),
               "Offset of |type| must match in QuicFrame and QuicStreamFrame");
 
+#if defined(__GNUC__)
+#pragma GCC diagnostic pop
+#endif
+
 // A inline size of 1 is chosen to optimize the typical use case of
 // 1-stream-frame in QuicTransmissionInfo.retransmittable_frames.
 typedef QuicInlinedVector<QuicFrame, 1> QuicFrames;
diff --git a/quic/core/frames/quic_inlined_frame.h b/quic/core/frames/quic_inlined_frame.h
index cfa32dc0..a543d2a2 100644
--- a/quic/core/frames/quic_inlined_frame.h
+++ b/quic/core/frames/quic_inlined_frame.h
@@ -12,6 +12,11 @@
 
 namespace quic {
 
+#if defined(__GNUC__)
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Winvalid-offsetof"
+#endif
+
 // QuicInlinedFrame is the base class of all frame types that is inlined in the
 // QuicFrame class. It gurantees all inlined frame types contain a 'type' field
 // at offset 0, such that QuicFrame.type can get the correct frame type for both
@@ -29,6 +34,10 @@ struct QUIC_EXPORT_PRIVATE QuicInlinedFrame {
   }
 };
 
+#if defined(__GNUC__)
+#pragma GCC diagnostic pop
+#endif
+
 }  // namespace quic
 
 #endif  // QUICHE_QUIC_CORE_FRAMES_QUIC_INLINED_FRAME_H_
-- 
2.17.1

